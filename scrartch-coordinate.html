<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>æ±ªæ±ªéšŠå¤§åæ“Šï¼šåº§æ¨™ä¸Ÿä¸Ÿæ¨‚ï¼</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@700;900&display=swap');
        
        body {
            font-family: 'Noto Sans TC', sans-serif;
            /* èƒŒæ™¯æ”¹ç‚ºç¨å¾®äº®ä¸€é»çš„æ·±è—è‰²ï¼Œæ¯”è¼ƒä¸å£“æŠ‘ */
            background-color: #1e293b;
            color: #f1f5f9;
            overflow-x: hidden;
            overscroll-behavior: none;
            min-height: 100vh;
            user-select: none;
            /* å¢åŠ å¯æ„›çš„èƒŒæ™¯ç´‹ç† */
            background-image: radial-gradient(#334155 1px, transparent 1px);
            background-size: 20px 20px;
        }

        .game-font {
            font-family: 'Noto Sans TC', sans-serif;
            font-weight: 900;
            letter-spacing: 0.05em;
        }

        .title-shadow {
            text-shadow: 3px 3px 0px #000, 5px 5px 0px rgba(0,0,0,0.3);
        }

        #game-canvas {
            cursor: none;
            /* é‚Šæ¡†æ”¹ç‚ºäº®é»ƒè‰²ï¼Œæ¯”è¼ƒæ´»æ½‘ */
            border: 4px solid #fbbf24;
            border-radius: 12px;
            background-color: #0f172a;
            width: 100%;
            height: auto;
            touch-action: none;
            box-shadow: 0 10px 25px -5px rgba(251, 191, 36, 0.3);
        }

        /* å‹•ç•«é¡åˆ¥ */
        .shake-light { animation: shakeLight 0.2s both; }
        .shake-heavy { animation: shakeHeavy 0.5s both; }
        .flash-red { animation: flashRed 0.4s ease-out forwards; }
        .flash-white { animation: flashWhite 0.6s ease-out forwards; }
        .bar-shake { animation: barShake 0.3s both; }

        @keyframes shakeLight {
            10%, 90% { transform: translate3d(-2px, 0, 0); }
            20%, 80% { transform: translate3d(3px, 0, 0); }
            30%, 50%, 70% { transform: translate3d(-4px, 0, 0); }
            40%, 60% { transform: translate3d(4px, 0, 0); }
        }

        @keyframes shakeHeavy {
            0% { transform: translate(4px, 4px) rotate(0deg); }
            10% { transform: translate(-4px, -6px) rotate(-2deg); }
            30% { transform: translate(8px, 6px) rotate(2deg); }
            50% { transform: translate(-4px, 2px) rotate(-1deg); }
            100% { transform: translate(0, 0) rotate(0deg); }
        }

        @keyframes flashRed {
            0% { background: rgba(239, 68, 68, 0); }
            20% { background: rgba(239, 68, 68, 0.4); }
            100% { background: rgba(239, 68, 68, 0); }
        }

        @keyframes flashWhite {
            0% { background: rgba(255, 255, 255, 0); }
            20% { background: rgba(255, 255, 255, 0.8); }
            100% { background: rgba(255, 255, 255, 0); }
        }

        @keyframes barShake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-5px) rotate(-1deg); }
            75% { transform: translateX(5px) rotate(1deg); }
        }

        .stat-bar { transition: width 0.4s cubic-bezier(0.34, 1.56, 0.64, 1); }

        /* ä¸­å¤®å›é¥‹è¨Šæ¯å‹•ç•« - æ›´Qå½ˆ */
        .center-feedback {
            position: absolute;
            left: 50%; top: 45%;
            transform: translate(-50%, -50%);
            pointer-events: none;
            display: flex; flex-direction: column;
            align-items: center; justify-content: center;
            z-index: 150;
            animation: centerPop 1s cubic-bezier(0.68, -0.55, 0.265, 1.55) forwards;
        }

        @keyframes centerPop {
            0% { transform: translate(-50%, 0%) scale(0.3); opacity: 0; }
            40% { transform: translate(-50%, -50%) scale(1.3); opacity: 1; }
            80% { transform: translate(-50%, -50%) scale(1); opacity: 1; }
            100% { transform: translate(-50%, -100%) scale(0.8); opacity: 0; }
        }

        .icon-container {
            display: flex; flex-wrap: wrap; 
            width: 100%; gap: 3px;
            min-height: 2.5rem; align-items: center;
        }
        .icon-unit { font-size: 1.4rem; line-height: 1; transition: all 0.5s ease; filter: drop-shadow(2px 2px 0px rgba(0,0,0,0.3)); }
        /* å¤±æ•—çš„åœ–æ¨™è®Šæˆå“­è‡‰ */
        .is-lost.dog-unit::before { content: "ğŸ˜­"; position:absolute; opacity: 0.8; font-size:1.2rem;}
        .is-lost.cat-unit::before { content: "ğŸ˜¿"; position:absolute; opacity: 0.8; font-size:1.2rem;}
        .is-lost { filter: grayscale(80%) opacity(0.4); transform: scale(0.8) rotate(10deg); }

        .modal-animate { animation: bounceIn 0.5s cubic-bezier(0.68, -0.55, 0.265, 1.55); }
        @keyframes bounceIn { from { opacity: 0; transform: scale(0.8); } to { opacity: 1; transform: scale(1); } }

        .guide-text { animation: guidePulse 1.5s infinite alternate; }
        @keyframes guidePulse {
            from { transform: scale(1); text-shadow: 0 0 5px #fbbf24; }
            to { transform: scale(1.05); text-shadow: 0 0 15px #fbbf24, 0 0 20px #f59e0b; }
        }
        
        /* æ–°å¢ï¼šåº§æ¨™é¡¯ç¤ºæ¢çš„æ¨£å¼ */
        .coord-banner {
            background: linear-gradient(135deg, #f59e0b, #fbbf24);
            box-shadow: 0 4px 0 #b45309;
            transform: translateY(0);
            transition: transform 0.2s;
        }
        .coord-banner.updated {
            animation: bannerPop 0.3s ease-out;
        }
        @keyframes bannerPop {
            0% { transform: scale(1); }
            50% { transform: scale(1.1); background: #fde047; }
            100% { transform: scale(1); }
        }

    </style>
</head>
<body class="flex flex-col items-center py-4 px-3 md:py-8 md:px-4">

    <div id="screen-effect" class="fixed inset-0 pointer-events-none z-[100]"></div>

    <div class="w-full max-w-2xl mb-4 space-y-3">
        <div class="flex flex-col md:flex-row justify-between items-center md:items-end gap-3 text-center md:text-left">
            <div>
                <h1 class="text-3xl md:text-4xl font-black text-yellow-400 game-font title-shadow tracking-wider transform -rotate-1">ğŸš€ æ±ªæ±ªéšŠå¤§åæ“Šï¼</h1>
                <p class="text-sm text-blue-200 font-bold mt-1 flex items-center justify-center md:justify-start gap-2">
                    <span class="text-xl">ğŸ–</span>
                    <span>å¥ªå›è¢«å–µå–µå·èµ°çš„é«˜ç´šè‚‰ä¹¾ï¼</span>
                </p>
            </div>
            <div class="flex gap-3 w-full md:w-auto justify-center">
                <button onclick="showPrologue()" class="flex-1 md:flex-none px-4 py-2 bg-blue-600 border-b-4 border-blue-800 rounded-xl font-black text-white hover:bg-blue-500 active:border-b-0 active:translate-y-[4px] transition-all text-sm shadow-lg">
                    ğŸ“œ ä»»å‹™èªªæ˜æ›¸
                </button>
                <button id="btn-reset" onclick="resetGame()" class="flex-1 md:flex-none px-4 py-2 bg-rose-600 border-b-4 border-rose-800 rounded-xl font-black text-white hover:bg-rose-500 active:border-b-0 active:translate-y-[4px] transition-all text-sm shadow-lg">
                    ğŸ”„ é‡æ–°é–‹å§‹
                </button>
            </div>
        </div>

        <div class="grid grid-cols-2 gap-3 md:gap-4">
            <div id="dog-panel" class="bg-blue-900/60 p-2 md:p-3 rounded-2xl border-2 border-blue-400 shadow-lg relative overflow-hidden">
                <div class="absolute inset-0 bg-blue-600/10 z-0"></div>
                <div class="relative z-10">
                    <div class="flex justify-between items-center mb-1 px-1">
                        <span class="font-black text-blue-300 text-sm md:text-base">ğŸ¶ æ±ªæ±ªéšŠå£«æ°£</span>
                        <span id="dog-percent" class="font-mono font-black text-white text-base md:text-lg drop-shadow">100%</span>
                    </div>
                    <div class="w-full bg-gray-800/80 h-4 md:h-5 rounded-full overflow-hidden mb-2 border border-blue-500/50 p-[2px]">
                        <div id="dog-bar" class="stat-bar bg-gradient-to-r from-blue-500 via-blue-400 to-cyan-300 h-full rounded-full shadow-[0_0_10px_rgba(59,130,246,0.5)]" style="width: 100%;"></div>
                    </div>
                    <div id="dog-icons" class="icon-container justify-start px-1"></div>
                </div>
            </div>

            <div id="cat-panel" class="bg-red-900/60 p-2 md:p-3 rounded-2xl border-2 border-red-400 shadow-lg text-right relative overflow-hidden">
                 <div class="absolute inset-0 bg-red-600/10 z-0"></div>
                 <div class="relative z-10">
                    <div class="flex justify-between items-center mb-1 px-1">
                        <span id="cat-percent" class="font-mono font-black text-white text-base md:text-lg drop-shadow">100%</span>
                        <span class="font-black text-red-300 text-sm md:text-base">å–µå–µè»åœ˜åŸºåœ° ğŸ˜¼</span>
                    </div>
                    <div class="w-full bg-gray-800/80 h-4 md:h-5 rounded-full overflow-hidden flex justify-end mb-2 border border-red-500/50 p-[2px]">
                        <div id="cat-bar" class="stat-bar bg-gradient-to-l from-red-500 via-red-400 to-orange-300 h-full rounded-full shadow-[0_0_10px_rgba(239,68,68,0.5)]" style="width: 100%;"></div>
                    </div>
                    <div id="cat-icons" class="icon-container justify-end px-1"></div>
                </div>
            </div>
        </div>
    </div>

    <div class="w-full max-w-2xl relative space-y-3">
        
        <div id="coord-banner" class="coord-banner w-full py-3 px-4 rounded-xl flex flex-col md:flex-row items-center justify-center md:justify-between gap-2 text-center md:text-left">
            <div class="flex items-center gap-2">
                <span class="text-2xl animate-bounce">ğŸ“¡</span>
                <span class="text-orange-900 font-black text-sm md:text-base tracking-wider">ç‹—ç‹—åµæŸ¥å“¡å›å ±ä½ç½®ï¼š</span>
            </div>
            <div class="bg-black/20 rounded-lg px-4 py-1">
                 <span id="target-coords" class="text-2xl md:text-3xl font-mono font-black text-white tracking-widest drop-shadow-md">
                    é€£ç·šä¸­...
                </span>
            </div>
        </div>

        <div class="relative w-full aspect-[4/3] rounded-xl overflow-hidden shadow-2xl bg-[#0f172a]">
            <canvas id="game-canvas" width="800" height="600" class="w-full h-full object-contain block"></canvas>
            
            <div id="effect-layer" class="absolute inset-0 pointer-events-none overflow-hidden"></div>
        </div>

        <p class="guide-text font-black text-base md:text-lg mt-3 text-center text-yellow-400">
            ğŸ‘‡ å¿«ç”¨æ»‘é¼ /æ‰‹æŒ‡ï¼Œé»æ“Šä¸Šé¢å›å ±çš„åº§æ¨™é»ï¼ ğŸ‘‡
        </p>
    </div>

    <script>
        const canvas = document.getElementById('game-canvas');
        const ctx = canvas.getContext('2d');
        const targetDisplay = document.getElementById('target-coords');
        const coordBanner = document.getElementById('coord-banner');
        const effectLayer = document.getElementById('effect-layer');
        const screenEffect = document.getElementById('screen-effect');

        const uiElements = {
            dogBar: document.getElementById('dog-bar'),
            dogPercent: document.getElementById('dog-percent'),
            dogIcons: document.getElementById('dog-icons'),
            dogPanel: document.getElementById('dog-panel'),
            catBar: document.getElementById('cat-bar'),
            catPercent: document.getElementById('cat-percent'),
            catIcons: document.getElementById('cat-icons'),
            catPanel: document.getElementById('cat-panel')
        };

        const GRID_COLS = 5; 
        const GRID_ROWS = 5; 
        const PADDING = 70; // å¢åŠ é‚Šè·è®“å­—æ¯”è¼ƒä¸æœƒåˆ‡åˆ°
        const xValues = [-240, -120, 0, 120, 240];
        const yValues = [180, 90, 0, -90, -180];

        let currentTarget = { x: 0, y: 0 };
        let particles = []; 
        let craters = [];   
        let dogHP = 100;
        let catHP = 100;
        let isGameOver = false;
        let radarAngle = 0; 
        
        let mousePos = { x: -100, y: -100 }; 
        let nearestGridPoint = null;

        const audioCtx = new (window.AudioContext || window.webkitAudioContext)();

        // --- éŸ³æ•ˆç³»çµ± (èª¿æ•´å¾—æ¯”è¼ƒå¯æ„›ä¸€é») ---
        function playSound(type) {
            if (audioCtx.state === 'suspended') audioCtx.resume();
            const now = audioCtx.currentTime;
            const osc = audioCtx.createOscillator();
            const gain = audioCtx.createGain();

            if (type === 'hit' || type === 'crit') {
                const isCrit = type === 'crit';
                // èª¿æ•´é »ç‡ï¼Œè®“è²éŸ³æ¯”è¼ƒåƒå¡é€šçš„ã€Œè¹¦ï¼ã€
                osc.frequency.setValueAtTime(isCrit ? 150 : 200, now);
                osc.frequency.exponentialRampToValueAtTime(50, now + 0.3);
                gain.gain.setValueAtTime(isCrit ? 0.8 : 0.4, now);
                gain.gain.exponentialRampToValueAtTime(0.01, now + 0.3);
                
                osc.type = isCrit ? 'square' : 'sine'; // çˆ†æ“Šç”¨æ–¹æ³¢æ¯”è¼ƒæœ‰åŠ›
                osc.connect(gain); gain.connect(audioCtx.destination);
                osc.start(); osc.stop(now + 0.3);

            } else if (type === 'miss') {
                // æ¯”è¼ƒå¯æ„›çš„ã€Œå–”å–”...ã€å¤±æ•—è²
                osc.type = 'triangle';
                osc.frequency.setValueAtTime(300, now);
                osc.frequency.linearRampToValueAtTime(200, now + 0.2);
                osc.frequency.linearRampToValueAtTime(150, now + 0.4);
                gain.gain.setValueAtTime(0.3, now);
                gain.gain.linearRampToValueAtTime(0, now + 0.4);
                osc.connect(gain); gain.connect(audioCtx.destination);
                osc.start(); osc.stop(now + 0.4);
            } else if (type === 'pop') {
                // é¸ä¸­ç›®æ¨™çš„å¯æ„›æ³¢æ³¢è²
                osc.type = 'sine';
                osc.frequency.setValueAtTime(600, now);
                osc.frequency.exponentialRampToValueAtTime(1000, now + 0.1);
                gain.gain.setValueAtTime(0.1, now);
                gain.gain.exponentialRampToValueAtTime(0.01, now + 0.1);
                osc.connect(gain); gain.connect(audioCtx.destination);
                osc.start(); osc.stop(now + 0.1);
            }
        }

        function triggerAnim(element, className) {
            element.classList.remove(className);
            void element.offsetWidth;
            element.classList.add(className);
        }

        [canvas, uiElements.dogPanel, uiElements.catPanel, screenEffect, coordBanner].forEach(el => {
            el.addEventListener('animationend', (e) => {
                el.classList.remove(e.animationName);
                ['shake-light', 'shake-heavy', 'bar-shake', 'flash-red', 'flash-white', 'updated'].forEach(cls => {
                     if(el.classList.contains(cls)) el.classList.remove(cls);
                });
            });
        });

        function initGame() {
            isGameOver = false;
            dogHP = 100; catHP = 100;
            particles = []; craters = [];
            updateUI();
            spawnTarget();
        }

        function spawnTarget() {
            const rx = xValues[Math.floor(Math.random() * xValues.length)];
            const ry = yValues[Math.floor(Math.random() * yValues.length)];
            currentTarget = { x: rx, y: ry };
            targetDisplay.innerText = `X:${rx} / Y:${ry}`;
            // è§¸ç™¼ä¸Šæ–¹æ©«æ¢çš„å‹•ç•«
            triggerAnim(coordBanner, 'updated');
        }

        function updateUI() {
            dogHP = Math.max(0, dogHP);
            catHP = Math.max(0, catHP);
            
            uiElements.dogBar.style.width = dogHP + '%';
            uiElements.dogPercent.innerText = dogHP + '%';
            uiElements.catBar.style.width = catHP + '%';
            uiElements.catPercent.innerText = catHP + '%';

            const updateIcons = (container, hp, char, unitClass) => {
                let html = "";
                const active = Math.ceil(hp / 10);
                for(let i=1; i<=10; i++) {
                    const isLost = char.includes('ğŸ¶') ? i > active : (11-i) > active;
                    html += `<span class="icon-unit ${unitClass} ${isLost ? 'is-lost' : ''}">${char}</span>`;
                }
                container.innerHTML = html;
            };
            
            updateIcons(uiElements.dogIcons, dogHP, 'ğŸ¶', 'dog-unit');
            updateIcons(uiElements.catIcons, catHP, 'ğŸ˜¼', 'cat-unit');

            if (!isGameOver) {
                if (catHP <= 0) { isGameOver = true; endGame("å¤ªæ£’äº†ï¼è‚‰ä¹¾å¥ªå›å¤§æˆåŠŸï¼ğŸ‰", true); }
                else if (dogHP <= 0) { isGameOver = true; endGame("å—šå—š...è‚‰ä¹¾è¢«å–µå–µåƒå…‰äº†...ğŸ˜­", false); }
            }
        }

        function getCanvasPoint(gx, gy) {
            const drawW = canvas.width - (PADDING * 2);
            const drawH = canvas.height - (PADDING * 2);
            const normX = (gx + 240) / 480; 
            const cx = PADDING + normX * drawW;
            const normY = (180 - gy) / 360;
            const cy = PADDING + normY * drawH;
            return { x: cx, y: cy };
        }

        function draw() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            // å¯æ„›ä¸€é»çš„é›·é”èƒŒæ™¯
            radarAngle += 0.015;
            const cx = canvas.width / 2;
            const cy = canvas.height / 2;
            const gradient = ctx.createConicGradient(radarAngle, cx, cy);
            gradient.addColorStop(0, 'rgba(251, 191, 36, 0)');
            gradient.addColorStop(0.15, 'rgba(251, 191, 36, 0.1)'); // é»ƒè‰²æƒæç·š
            gradient.addColorStop(1, 'rgba(251, 191, 36, 0)');
            ctx.fillStyle = gradient;
            ctx.fillRect(0,0, canvas.width, canvas.height);

            // ç¹ªè£½ç¶²æ ¼èˆ‡æ–‡å­— (å­—é«”åŠ å¤§è®Šç²—)
            ctx.lineWidth = 2;
            ctx.font = "900 18px 'Noto Sans TC', sans-serif";
            ctx.textAlign = "center";
            ctx.textBaseline = "middle";

            // Xè»¸
            xValues.forEach(val => {
                const p = getCanvasPoint(val, 0);
                ctx.beginPath();
                ctx.strokeStyle = val === 0 ? '#60a5fa' : '#334155'; 
                ctx.lineWidth = val === 0 ? 3 : 2;
                ctx.moveTo(p.x, PADDING - 20); ctx.lineTo(p.x, canvas.height - PADDING + 20);
                ctx.stroke();
                
                ctx.fillStyle = val === 0 ? '#60a5fa' : '#94a3b8';
                // å¢åŠ æ–‡å­—é™°å½±è®“å®ƒæ›´æ¸…æ¥š
                ctx.shadowColor = 'rgba(0,0,0,0.5)'; ctx.shadowBlur = 4;
                ctx.fillText(val, p.x, canvas.height - PADDING + 45);
                ctx.shadowBlur = 0;
            });

            // Yè»¸
            yValues.forEach(val => {
                const p = getCanvasPoint(0, val);
                ctx.beginPath();
                ctx.strokeStyle = val === 0 ? '#f87171' : '#334155';
                ctx.lineWidth = val === 0 ? 3 : 2;
                ctx.moveTo(PADDING - 20, p.y); ctx.lineTo(canvas.width - PADDING + 20, p.y);
                ctx.stroke();

                ctx.fillStyle = val === 0 ? '#f87171' : '#94a3b8';
                ctx.shadowColor = 'rgba(0,0,0,0.5)'; ctx.shadowBlur = 4;
                ctx.fillText(val, PADDING - 45, p.y);
                ctx.shadowBlur = 0;
            });

            // ç¹ªè£½å½ˆå‘ (æ”¹æˆå¯æ„›çš„å‰å‰)
            craters.forEach((c, i) => {
                ctx.beginPath();
                ctx.strokeStyle = `rgba(255, 100, 100, ${c.alpha})`;
                ctx.lineWidth = 4;
                const size = c.size * 0.8;
                ctx.moveTo(c.x - size, c.y - size); ctx.lineTo(c.x + size, c.y + size);
                ctx.moveTo(c.x + size, c.y - size); ctx.lineTo(c.x - size, c.y + size);
                ctx.stroke();
                c.alpha -= 0.005;
                if(c.alpha <= 0) craters.splice(i, 1);
            });

            // ç¹ªè£½æº–å¿ƒèˆ‡å¸é™„é»
            if (!isGameOver) {
                let minDist = 9999;
                let targetGrid = null;

                for (let x of xValues) {
                    for (let y of yValues) {
                        const pt = getCanvasPoint(x, y);
                        const dist = Math.sqrt((mousePos.x - pt.x)**2 + (mousePos.y - pt.y)**2);
                        if (dist < 45) { 
                            if (dist < minDist) {
                                minDist = dist;
                                targetGrid = { gx: x, gy: y, cx: pt.x, cy: pt.y };
                            }
                        }
                    }
                }
                
                // å¦‚æœå¸é™„é»æ”¹è®Šäº†ï¼Œæ’­æ”¾ä¸€å€‹å°éŸ³æ•ˆ
                if (targetGrid && (!nearestGridPoint || nearestGridPoint.gx !== targetGrid.gx || nearestGridPoint.gy !== targetGrid.gy)) {
                    playSound('pop');
                }
                nearestGridPoint = targetGrid;

                // æ¸¸æ¨™åå­—ç·š
                ctx.strokeStyle = 'rgba(251, 191, 36, 0.5)';
                ctx.lineWidth = 2;
                ctx.setLineDash([5, 5]); // è™›ç·šæ¯”è¼ƒå¯æ„›
                ctx.beginPath();
                ctx.moveTo(mousePos.x, 0); ctx.lineTo(mousePos.x, canvas.height);
                ctx.moveTo(0, mousePos.y); ctx.lineTo(canvas.width, mousePos.y);
                ctx.stroke();
                ctx.setLineDash([]);

                // å¸é™„æ¨™è¨˜ (æ”¹æˆé–ƒçˆçš„é»ƒè‰²åœˆåœˆ)
                if (nearestGridPoint) {
                    const pulse = Math.sin(Date.now() / 100) * 5;
                    ctx.strokeStyle = '#fbbf24';
                    ctx.lineWidth = 4;
                    ctx.beginPath();
                    ctx.arc(nearestGridPoint.cx, nearestGridPoint.cy, 20 + pulse, 0, Math.PI*2);
                    ctx.stroke();
                    
                    // é¡¯ç¤ºç•¶å‰é¸ä¸­åº§æ¨™çš„æç¤ºæ¡†
                    ctx.fillStyle = 'rgba(251, 191, 36, 0.9)';
                    ctx.fillRect(mousePos.x + 10, mousePos.y - 40, 100, 30);
                    ctx.fillStyle = '#000';
                    ctx.font = "bold 16px sans-serif";
                    ctx.fillText(`${nearestGridPoint.gx}, ${nearestGridPoint.gy}`, mousePos.x + 60, mousePos.y - 25);
                }
            }

            // ç¹ªè£½çˆ†ç‚¸ç²’å­ (å¢åŠ é¡è‰²è®ŠåŒ–)
            particles.forEach((p, i) => {
                ctx.beginPath();
                ctx.fillStyle = p.color;
                ctx.arc(p.x, p.y, p.size, 0, Math.PI*2);
                ctx.fill();
                p.x += p.vx; p.y += p.vy;
                p.life -= p.decay; p.size *= 0.96;
                if (p.life <= 0) particles.splice(i, 1);
            });

            requestAnimationFrame(draw);
        }

        function getEventPos(e) {
            const rect = canvas.getBoundingClientRect();
            const clientX = e.touches ? e.touches[0].clientX : e.clientX;
            const clientY = e.touches ? e.touches[0].clientY : e.clientY;
            return {
                x: (clientX - rect.left) * (canvas.width / rect.width),
                y: (clientY - rect.top) * (canvas.height / rect.height)
            };
        }

        function handleInputStart(e) {
            if (isGameOver) return;
            if(e.type === 'touchstart') e.preventDefault(); 
            
            if (nearestGridPoint) {
                attemptAttack(nearestGridPoint);
            } else {
                const pos = getEventPos(e);
                createExplosion(pos.x, pos.y, ['#94a3b8', '#cbd5e1'], 5);
                playSound('miss');
            }
        }

        function handleInputMove(e) {
            if (isGameOver) return;
            if(e.type === 'touchmove') e.preventDefault();
            mousePos = getEventPos(e);
        }

        canvas.addEventListener('mousedown', handleInputStart);
        canvas.addEventListener('mousemove', handleInputMove);
        canvas.addEventListener('touchstart', handleInputStart, {passive: false});
        canvas.addEventListener('touchmove', handleInputMove, {passive: false});
        canvas.addEventListener('mouseleave', () => { mousePos = {x:-999, y:-999}; nearestGridPoint = null; });


        function attemptAttack(target) {
            // æª¢æŸ¥æ˜¯å¦å‘½ä¸­ç›®æ¨™
            if (target.gx === currentTarget.x && target.gy === currentTarget.y) {
                // å‘½ä¸­ï¼
                const isCrit = Math.random() < 0.3; // æé«˜ä¸€é»çˆ†æ“Šç‡è®“å°æœ‹å‹é–‹å¿ƒ
                const dmg = isCrit ? 15 : Math.floor(Math.random() * 5) + 5;
                
                catHP -= dmg;
                playSound(isCrit ? 'crit' : 'hit');
                triggerAnim(canvas, isCrit ? 'shake-heavy' : 'shake-light');
                triggerAnim(screenEffect, isCrit ? 'flash-red' : 'flash-white');
                triggerAnim(uiElements.catPanel, 'bar-shake');

                // è¯éº—çˆ†ç‚¸ (ä½¿ç”¨æš–è‰²ç³»)
                createExplosion(target.cx, target.cy, isCrit ? ['#f59e0b', '#ef4444', '#fbbf24'] : ['#f97316', '#fbbf24'], isCrit ? 50 : 30);
                
                // æ›´æœ‰è¶£çš„å›é¥‹æ–‡å­—
                showFeedback(isCrit ? `è¶…ç´šå¤§å‘½ä¸­ï¼å–µå–µåš‡é£›äº†ï¼-${dmg}` : `æ‰“ä¸­äº†ï¼è‚‰ä¹¾æ‰å‡ºä¾†äº†ï¼-${dmg}`, 
                             isCrit ? "text-yellow-300 scale-125" : "text-green-300", 
                             isCrit ? "ğŸ™€ğŸ’¥ğŸš€" : "ğŸ˜¼ğŸ’¢");
                
                spawnTarget(); 
            } else {
                // æ²’ä¸­
                const isFriendly = Math.random() < 0.3;
                if (isFriendly) {
                    dogHP -= 10;
                    playSound('miss');
                    triggerAnim(uiElements.dogPanel, 'bar-shake');
                    triggerAnim(canvas, 'shake-light');
                    createExplosion(target.cx, target.cy, ['#a855f7', '#ec4899'], 20);
                    showFeedback("å“å‘€ï¼æ‰“åˆ°è‡ªå·±äººäº†å•¦ï¼-10", "text-pink-400", "ğŸ¶ğŸ’¦ğŸ˜µ");
                } else {
                    const dmg = Math.floor(Math.random() * 3) + 2;
                    dogHP -= dmg;
                    playSound('miss');
                    createExplosion(target.cx, target.cy, ['#64748b', '#94a3b8'], 10);
                    craters.push({x: target.cx, y: target.cy, size: 25, alpha: 1});
                    showFeedback("ç³Ÿç³•ï¼Œä½ç½®çœ‹éŒ¯äº†... -"+dmg, "text-gray-300", "ğŸ’¨â“");
                    triggerAnim(uiElements.dogPanel, 'bar-shake');
                }
            }
            updateUI();
        }

        function createExplosion(x, y, colors, count) {
            for(let i=0; i<count; i++) {
                const angle = Math.random() * Math.PI * 2;
                const speed = Math.random() * 6 + 2;
                particles.push({
                    x: x, y: y,
                    vx: Math.cos(angle) * speed,
                    vy: Math.sin(angle) * speed,
                    life: 1.0,
                    decay: Math.random() * 0.02 + 0.02,
                    size: Math.random() * 6 + 3,
                    color: colors[Math.floor(Math.random() * colors.length)]
                });
            }
        }

        function showFeedback(text, colorClass, emoji) {
            const el = document.createElement('div');
            // å¢åŠ å¡é€šæ„Ÿçš„é‚Šæ¡†å’Œé™°å½±
            el.className = `center-feedback game-font ${colorClass}`;
            el.innerHTML = `
                <span class="text-7xl drop-shadow-2xl mb-2 filter hover:brightness-110">${emoji}</span>
                <span class="text-3xl md:text-4xl whitespace-nowrap title-shadow bg-black/70 px-8 py-4 rounded-3xl border-4 border-white/30 backdrop-blur-md shadow-[0_0_20px_rgba(0,0,0,0.5)]">${text}</span>
            `;
            effectLayer.appendChild(el);
            setTimeout(() => el.remove(), 1200);
        }

        // --- å…¨æ–°çš„å¯æ„›ç‰ˆå‰æƒ…æè¦ ---
        function showPrologue() {
            // æ’­æ”¾ä¸€å€‹å¯æ„›çš„é–‹å ´éŸ³æ•ˆ (ç”¨ç¾æœ‰çš„ miss éŸ³æ•ˆä»£æ›¿ä¸€ä¸‹)
            playSound('miss');
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 flex items-center justify-center bg-black/80 z-[300] p-4 modal-animate backdrop-blur-sm';
            modal.id = 'prologue-modal';
            modal.innerHTML = `
                <div class="max-w-2xl w-full bg-gradient-to-b from-blue-900 to-slate-900 border-4 border-yellow-400 rounded-3xl p-6 md:p-8 shadow-2xl relative overflow-hidden text-center">
                    <div class="absolute top-[-20px] left-[-20px] text-6xl opacity-20 rotate-[-20deg]">ğŸ¦´</div>
                    <div class="absolute bottom-[-20px] right-[-20px] text-6xl opacity-20 rotate-[20deg]">ğŸ¾</div>
                    
                    <h2 class="text-3xl md:text-4xl font-black text-yellow-400 mb-6 tracking-wider title-shadow">
                        ğŸš¨ ç·Šæ€¥ä»»å‹™ï¼šè‚‰ä¹¾ä¿è¡›æˆ°ï¼
                    </h2>
                    
                    <div class="bg-black/30 rounded-2xl p-4 md:p-6 text-lg md:text-xl text-blue-100 leading-relaxed font-bold space-y-6 text-left">
                        <p>
                            <span class="text-3xl">ğŸ¶</span> <span class="text-yellow-300">æ±ªæ±ªéšŠé•·ï¼š</span><br>
                            ã€Œå„ä½éšŠå“¡è½å¥½äº†ï¼éš”å£çš„<span class="text-red-300">å£å£å–µå–µè»åœ˜</span>è¶æˆ‘å€‘ç¡åˆè¦ºï¼ŒæŠŠå€‰åº«è£¡æœ€è²´çš„ã€A5å’Œç‰›å£å‘³è‚‰ä¹¾ã€å…¨éƒ¨å·èµ°äº†ï¼ä¸å¯åŸè«’ï¼ã€
                        </p>
                        <p>
                            <span class="text-3xl">ğŸ˜¼</span> <span class="text-red-300">å–µå–µè€å¤§ï¼š</span><br>
                            ã€Œå–µå“ˆå“ˆï¼ç¬¨ç‹—ï¼è‚‰ä¹¾ç¾åœ¨æ˜¯æˆ‘å€‘çš„äº†ï¼æœ‰æœ¬äº‹å°±ç”¨ä½ å€‘çš„ã€ä¸Ÿä¸Ÿçƒç™¼å°„å™¨ã€æ‰“éä¾†å•Šï½ã€
                        </p>
                        <hr class="border-blue-500/50">
                        <p class="text-center text-yellow-300 text-2xl">
                            <span class="text-4xl block mb-2">ğŸ¯ ä½ çš„ä»»å‹™ ğŸ¯</span>
                            çœ‹æ¸…æ¥šä¸Šæ–¹å›å ±çš„ <span class="bg-yellow-500 text-black px-2 rounded">X / Y åº§æ¨™</span>ï¼Œåœ¨åº•ä¸‹çš„åœ°åœ–ä¸ŠæŠŠçƒçƒä¸Ÿéå»ï¼ŒæŠŠå–µå–µè¶•èµ°ï¼
                        </p>
                        <div class="flex justify-center gap-4 text-base text-gray-300 bg-black/20 p-3 rounded-xl">
                            <div class="text-center"><span class="text-blue-300 font-black text-xl">X è»¸</span><br>â¬…ï¸ å¾€å·¦æ˜¯è² çš„<br>â¡ï¸ å¾€å³æ˜¯æ­£çš„</div>
                            <div class="w-[2px] bg-gray-500"></div>
                            <div class="text-center"><span class="text-red-300 font-black text-xl">Y è»¸</span><br>â¬†ï¸ å¾€ä¸Šæ˜¯æ­£çš„<br>â¬‡ï¸ å¾€ä¸‹æ˜¯è² çš„</div>
                        </div>
                    </div>

                    <button onclick="document.getElementById('prologue-modal').remove(); playSound('pop');" class="w-full md:w-auto px-12 mt-8 py-4 bg-gradient-to-r from-yellow-500 to-orange-500 text-white font-black text-2xl rounded-2xl hover:from-yellow-400 hover:to-orange-400 transition-all shadow-xl active:scale-95 border-b-4 border-orange-700 animate-bounce">
                        æ²’å•é¡Œï¼å‡ºç™¼å¥ªå›è‚‰ä¹¾ï¼ğŸ¾
                    </button>
                </div>
            `;
            document.body.appendChild(modal);
        }

        function resetGame() {
            playSound('miss'); // ç”¨å¯æ„›çš„è²éŸ³ä»£æ›¿å™´å°„æ©Ÿè²
            triggerAnim(screenEffect, 'flash-white');
            setTimeout(() => { 
                initGame(); 
                showFeedback("éŠæˆ²é‡æ–°é–‹å§‹ï¼", "text-cyan-300", "ğŸ®âœ¨"); 
            }, 100);
        }

        function endGame(msg, isVictory) {
            setTimeout(() => {
                const finalMsg = document.createElement('div');
                finalMsg.className = 'fixed inset-0 flex flex-col items-center justify-center bg-black/80 z-[200] backdrop-blur-md modal-animate p-4';
                finalMsg.innerHTML = `
                <div class="text-center p-8 bg-gradient-to-b ${isVictory ? 'from-yellow-600 to-orange-700' : 'from-gray-700 to-gray-900'} border-4 ${isVictory ? 'border-yellow-400' : 'border-gray-500'} rounded-[40px] shadow-2xl max-w-md w-full relative overflow-hidden">
                    <div class="absolute inset-0 ${isVictory ? 'bg-[radial-gradient(circle,rgba(255,255,0,0.3)_0%,rgba(0,0,0,0)_70%)]' : 'bg-[radial-gradient(circle,rgba(255,255,255,0.1)_0%,rgba(0,0,0,0)_70%)]'} animate-pulse z-0"></div>
                    <div class="relative z-10">
                        <div class="text-[100px] mb-4 animate-[bounce_1s_infinite] filter drop-shadow-xl">${isVictory ? 'ğŸ†' : 'ğŸ˜¿'}</div>
                        <h2 class="text-4xl font-black mb-4 ${isVictory ? 'text-yellow-300' : 'text-gray-300'} title-shadow">${isVictory ? 'å¤§ãƒ»å‹ãƒ»åˆ©ï¼' : 'æŒ‘ãƒ»æˆ°ãƒ»å¤±ãƒ»æ•—'}</h2>
                        <p class="text-white text-xl font-bold mb-8 bg-black/30 py-4 rounded-2xl">${msg}</p>
                        <button onclick="this.closest('.fixed').remove(); resetGame();" class="w-full py-4 ${isVictory ? 'bg-yellow-500 hover:bg-yellow-400 border-yellow-700' : 'bg-gray-500 hover:bg-gray-400 border-gray-700'} text-white font-black text-2xl rounded-2xl border-b-4 transition-all active:scale-95 shadow-lg">
                            ${isVictory ? 'å¥½è€¶ï¼å†ç©ä¸€æ¬¡ï¼' : 'ä¸ç”˜å¿ƒï¼å†è©¦ä¸€æ¬¡ï¼'}
                        </button>
                    </div>
                </div>`;
                document.body.appendChild(finalMsg);
            }, 500);
        }

        window.onload = () => { 
            initGame(); 
            requestAnimationFrame(draw); 
            setTimeout(showPrologue, 500);
        };
    </script>
</body>
</html>